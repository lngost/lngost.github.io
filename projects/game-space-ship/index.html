<!--
Author: lngost
Description: poor coding, my first complete html5 canvas game, have fun.
-->
<!DOCTYPE html>
<html>
    <head>
        <title>Space Ship</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="shortcut icon" href="../../images/myL.ico"/> <!-- The shortcut icon -->
        

        <style>
            body {
                margin: 0;
                padding: 0;
                height: 100%;
            }
            
            #game-container {
                margin: 0 auto;
            }

            #canvas {
                cursor: none;
                margin: 0;
                display: block;
                //display: none;
            }
            
            #dialog-container {
                position: absolute;
                z-index: 10;
                opacity: 0.7;
            }
            
            #title {
                width: 280px;
                height: 180px;
                margin: 30% auto;
                display: block;
            }
            
            #score {
                display: none;
                width: 280px;
                height: 180px;
                margin: 30% auto;
                border: 3px outset #424242;
                border-radius: 20px;
                box-shadow: 6px 6px 5px #616161;
                text-align: center;
            }
            
            #startup {
                width: 100px;
                height: 100px;
                border: 3px outset #424242;
                border-radius: 20px;
                box-shadow: 6px 6px 5px #616161;
                margin: 150px auto;
                cursor: pointer;
            }
            
            .score-title {
                font: 26px 'Arial Black', Gadget, sans-serif;
            }
            
            .help {
                width: 150px;
                margin: 10px auto;
                padding-left: 25px;
            }
            
            .score-num {
                font: 20px 'Comic Sans MS', cursive, sans-serif;
                margin: -20px auto 0;
            }
            
            .newtop-container {
                width: 200px;
                height: 40px;
                margin: 5px auto;
            }
            
            #newtop {
                font: 20px Impact, Charcoal, sans-serif;
                margin: 5px auto auto auto;
                display: none;
            }
            
            .topscore {
                float: left;
                font: italic 15px 'Comic Sans MS', cursive, sans-serif;
                margin: 0 0 0 20px;
            }
            
        </style>

        <script>
            
            function game() {
                
                var bgmusic = document.getElementById("bgmusic");
                var gameoverMusic = document.getElementById("gameover-music");
                //var bulletMusic = document.getElementById("bullet-music");
                var enemyMusic = document.getElementById("enemy-music");
                
                var imgBackground = new Image();
                var imgSpaceShip = new Image();
                var imgSpaceShipDestroyPhase1 = new Image();
                var imgSpaceShipDestroyPhase2 = new Image();
                var imgSpaceShipDestroyPhase3 = new Image();
                var imgBullet = new Image();
                var imgBulletDouble = new Image();
                var imgBulletDoubleSupply = new Image();
                var imgBomb = new Image();
                var imgBombSupply = new Image();
                
                var imgFlyerSmall = new Image();
                var imgFlyerSmallDestroyPhase1 = new Image();
                var imgFlyerSmallDestroyPhase2 = new Image();
                var imgFlyerMedium = new Image();
                var imgFlyerMediumDestroyPhase1 = new Image();
                var imgFlyerMediumDestroyPhase2 = new Image();
                var imgFlyerMediumDestroyPhase3 = new Image();
                var imgFlyerLarge = new Image();
                var imgFlyerLargeDestroyPhase1 = new Image();
                var imgFlyerLargeDestroyPhase2 = new Image();
                var imgFlyerLargeDestroyPhase3 = new Image();
                var imgFlyerLargeDestroyPhase4 = new Image();
                var imgFlyerLargeDestroyPhase5 = new Image();
                
                imgBackground.src = "images/background.png";
                imgSpaceShip.src = "images/space-ship.png";
                imgSpaceShipDestroyPhase1.src = "images/space-ship-des1.png";
                imgSpaceShipDestroyPhase2.src = "images/space-ship-des2.png";
                imgSpaceShipDestroyPhase3.src = "images/space-ship-des3.png";
                imgBullet.src = "images/bullet.png";
                imgBulletDouble.src = "images/bullet-double.png";
                imgBulletDoubleSupply.src = "images/bullet-double-supply.png";
                imgBomb.src = "images/bomb.png";
                imgBombSupply.src = "images/bomb-supply.png";
                imgFlyerSmall.src = "images/flyer-small.png";
                imgFlyerSmallDestroyPhase1.src = "images/flyer-small-des1.png";
                imgFlyerSmallDestroyPhase2.src = "images/flyer-small-des2.png";
                imgFlyerMedium.src = "images/flyer-medium.png";
                imgFlyerMediumDestroyPhase1.src = "images/flyer-medium-des1.png";
                imgFlyerMediumDestroyPhase2.src = "images/flyer-medium-des2.png";
                imgFlyerMediumDestroyPhase3.src = "images/flyer-medium-des3.png";
                imgFlyerLarge.src = "images/flyer-large.png";
                imgFlyerLargeDestroyPhase1.src = "images/flyer-large-des1.png";
                imgFlyerLargeDestroyPhase2.src = "images/flyer-large-des2.png";
                imgFlyerLargeDestroyPhase3.src = "images/flyer-large-des3.png";
                imgFlyerLargeDestroyPhase4.src = "images/flyer-large-des4.png";
                imgFlyerLargeDestroyPhase5.src = "images/flyer-large-des5.png";
                
                var FLYER_SMALL = 's';
                var FLYER_MEDIUM = 'm';
                var FLYER_LARGE = 'l';
                var SPEED_NORMAL = 2;
                var SPEED_QUICK = 5;
                
                var flagGamePause = false;
                var gameContainer = document.getElementById("game-container");
                var canvas = document.getElementById("canvas");
                var ctx = canvas.getContext("2d");
                canvas.height = gameContainer.offsetHeight;
                canvas.width = gameContainer.offsetWidth;
                var dialogContainer = document.getElementById("dialog-container");
                dialogContainer.style.height = gameContainer.offsetHeight + "px";
                dialogContainer.style.width = gameContainer.offsetWidth + "px";
                dialogContainer.style.margin = 0 - gameContainer.offsetHeight + "px 0 0 0";
                var titleContainer = document.getElementById("title");
                var scoreContainer = document.getElementById("score");
                
                // custom variables here
                var raf;
                var mouseX, mouseY;
                var numOfBullets = 20;
                var numOfFlyersSmall = 20;
                var numOfFlyersMedium = 10;
                var numOfFlyersLarge = 5;
                
                
                var background = {
                    x1: 0,
                    y1: 0,
                    x2: 0,
                    y2: 0,
                    init: function() {
                        this.x1 = 0;
                        this.y1 = 0;
                        this.x2 = 0;
                        this.y2 = 0 - canvas.height;
                    },
                    draw: function() {
                        if(this.y1 >= canvas.height) {
                            this.y1 = 0;
                        }
                        if(this.y2 >= 0) {
                            this.y2 = 0 - canvas.height;
                        }
                        
                        imgBackground.onload = ctx.drawImage(imgBackground, this.x1, this.y1, canvas.width, canvas.height);
                        imgBackground.onload = ctx.drawImage(imgBackground, this.x2, this.y2, canvas.width, canvas.height);
                        
                        ++this.y1;
                        ++this.y2;
                    }
                };
                
                
                function bullet() {
                    this.fire = false;
                    this.startX = 0;
                    this.startY = 0;
                    this.width = 3;
                    this.height = 15;
                    this.widthDouble = 16;
                    this.speed = 10;
                    this.reset = function() {
                        this.fire = false;
                    };
                    this.draw = function() {
                        imgBullet.onload = ctx.drawImage(imgBullet, this.startX, this.startY, this.width, this.height);
                    };
                    this.drawDouble = function() {
                        imgBulletDouble.onload = ctx.drawImage(imgBulletDouble, this.startX, this.startY, this.widthDouble, this.height);
                    };
                    this.bWidth = function() {
                        return this.width;
                    };
                    this.bWidthDouble = function() {
                        return this.widthDouble;
                    };
                }
                
                var bulletArray = new Array(numOfBullets);
                for(var i=0; i<numOfBullets; i++) {
                    bulletArray[i] = new bullet();
                }
                
                var ship = {
                    x: 0,
                    y: 0,
                    finalX: 0,
                    finalY: 0,
                    width: 70,
                    height: 80,
                    //realWidth: 50,
                    //realHeight: 70,
                    fireReady: 10, // down count to 0 on fire
                    doubleBullet: false,
                    doubleBulletPeriod: 60*15,
                    numOfBombs: 0,
                    crashed: false,
                    destroyDownCount: 80,
                    reset: function() {
                        this.fireReady = 10;
                        this.doubleBullet = false;
                        this.doubleBulletPeriod = 60*15;
                        this.numOfBombs = 0;
                        this.crashed = false;
                        this.destroyDownCount = 80;
                    },
                    draw: function() {
                        if(this.x <= 0) this.x = 0;
                        else if(this.x >= canvas.width - this.width) this.x = canvas.width - this.width;
                        if(this.y >= canvas.height - this.height) this.y = canvas.height - this.height;
                        else if(this.y <= 0) this.y = 0;
                        imgSpaceShip.onload = ctx.drawImage(imgSpaceShip, this.x, this.y, this.width, this.height);
                    },
                    drawDestroy: function(phase) {
                        if(phase === 1) {
                            imgSpaceShipDestroyPhase1.onload = ctx.drawImage(imgSpaceShipDestroyPhase1, this.finalX, this.finalY, this.width, this.height);
                        } else if(phase === 2) {
                            imgSpaceShipDestroyPhase2.onload = ctx.drawImage(imgSpaceShipDestroyPhase2, this.finalX, this.finalY, this.width, this.height);
                        } else if(phase === 3) {
                            imgSpaceShipDestroyPhase3.onload = ctx.drawImage(imgSpaceShipDestroyPhase3, this.finalX, this.finalY, this.width, this.height);
                        }
                    },
                    drawBomb: function() {
                        for(var i=0; i < this.numOfBombs; i++) {
                            imgBomb.onload = ctx.drawImage(imgBomb, 10+i*50, canvas.height-40, 40, 30);
                        }
                    },
                    setFinalPos: function(x, y) {
                        this.finalX = x;
                        this.finalY = y;
                    },
                    destroy: function() {
                        if(this.crashed) {
                            if(this.destroyDownCount > 70) {
                                this.drawDestroy(1);
                            } else if(this.destroyDownCount > 60) {
                                this.drawDestroy(2);
                            } else if(this.destroyDownCount > 0) {
                                this.drawDestroy(3);
                            } else if(this.destroyDownCount <= -60 * 3) {
                                this.crashed = false;
                                system.flagGameOver = true;
                            }
                            --this.destroyDownCount;
                        } else {
                            
                        }
                    },
                    fire: function() {
                        if(this.fireReady <= 0) {
                            // ready on fire
                            var readyIndex = -1;
                            for(var i=0; i<numOfBullets; i++) {
                                if(!bulletArray[i].fire) {
                                    readyIndex = i;
                                    break;
                                }
                            }
                            if(readyIndex >= 0) {
                                var b = bulletArray[readyIndex];
                                if(this.doubleBullet) {
                                    b.startX = this.x + this.width/2 - 7;
                                } else {
                                    b.startX = this.x + this.width/2;
                                }
                                b.startY = this.y - 10;
                                b.fire = true;
                                this.fireReady = 10;
                                //bulletMusic.currentTime = 0;
                                //bulletMusic.play();
                                if(this.doubleBullet) {
                                    b.drawDouble();
                                } else {
                                    b.draw();
                                }
                            }
                            
                        } else {
                            --this.fireReady;
                        }
                        
                        for(var i=0; i<numOfBullets; i++) {
                            if(bulletArray[i].fire) {
                                var b = bulletArray[i];
                                if(b.startY + b.height <= 0) {
                                    b.fire = false;
                                } else {
                                    b.startY -= b.speed;
                                    if(this.doubleBullet) {
                                        b.drawDouble();
                                    } else {
                                        b.draw();
                                    }
                                }
                            }
                        }
                        
                        if(this.doubleBullet) {
                            if(this.doubleBulletPeriod <= 0) {
                                this.doubleBullet = false;
                                this.doubleBulletPeriod = 60*15;
                            } else {
                                --this.doubleBulletPeriod;
                            }
                        }
                    },
                    loadBomb: function() {
                        if(this.numOfBombs < 3) {
                            ++this.numOfBombs;
                        }
                    },
                    useBomb: function() {
                        if(this.numOfBombs > 0 && !this.crashed) {
                            system.blowup();
                            --this.numOfBombs;
                        }
                    }
                };
                
                function flyer() {
                    this.flyerSize = FLYER_SMALL;
                    this.arrive = false;
                    this.hit = false;
                    this.destroyDownCount = 30;
                    this.x = 0;
                    this.y = 0;
                    this.width = 35;
                    this.height = 25;
                    this.speed = SPEED_NORMAL;
                    this.health = 0;
                    this.reset = function() {
                        this.arrive = false;
                        this.hit = false;
                    };
                    this.init = function(flyerSize) {
                        this.flyerSize = flyerSize;
                        this.speed = SPEED_NORMAL;
                        switch(this.flyerSize) {
                            case FLYER_SMALL: 
                                this.health = 2;
                                this.width = 35;
                                this.height = 25;
                                break;
                            case FLYER_MEDIUM: 
                                this.health = 5;
                                this.width = 45;
                                this.height = 55;
                                break;
                            case FLYER_LARGE: 
                                this.health = 15;
                                this.width = 120;
                                this.height = 160;
                                break;
                            default: break;
                        }
                    };
                    this.draw = function() {
                        switch(this.flyerSize) {
                            case FLYER_SMALL:
                                imgFlyerSmall.onload = ctx.drawImage(imgFlyerSmall, this.x, this.y - this.height, this.width, this.height);
                                break;
                            case FLYER_MEDIUM:
                                imgFlyerMedium.onload = ctx.drawImage(imgFlyerMedium, this.x, this.y - this.height, this.width, this.height);
                                break;
                            case FLYER_LARGE:
                                imgFlyerLarge.onload = ctx.drawImage(imgFlyerLarge, this.x, this.y - this.height, this.width, this.height);
                                break;
                            default: break;
                        }
                        
                    };
                    this.drawDestroy = function(phase) {
                        switch(this.flyerSize) {
                            case FLYER_SMALL:
                                if(phase === 1) {
                                    imgFlyerSmallDestroyPhase1.onload = ctx.drawImage(imgFlyerSmallDestroyPhase1, this.x, this.y - this.height, this.width, this.height);
                                } else if(phase === 2) {
                                    imgFlyerSmallDestroyPhase2.onload = ctx.drawImage(imgFlyerSmallDestroyPhase2, this.x, this.y - this.height, this.width, this.height);
                                }
                                break;
                            case FLYER_MEDIUM:
                                if(phase === 1) {
                                    imgFlyerMediumDestroyPhase1.onload = ctx.drawImage(imgFlyerMediumDestroyPhase1, this.x, this.y - this.height, this.width, this.height);
                                } else if(phase === 2) {
                                    imgFlyerMediumDestroyPhase2.onload = ctx.drawImage(imgFlyerMediumDestroyPhase2, this.x, this.y - this.height, this.width, this.height);
                                } else if(phase === 3) {
                                    imgFlyerMediumDestroyPhase3.onload = ctx.drawImage(imgFlyerMediumDestroyPhase3, this.x, this.y - this.height, this.width, this.height);
                                }
                                break;
                            case FLYER_LARGE:
                                if(phase === 1) {
                                    imgFlyerLargeDestroyPhase1.onload = ctx.drawImage(imgFlyerLargeDestroyPhase1, this.x, this.y - this.height, this.width, this.height);
                                } else if(phase === 2) {
                                    imgFlyerLargeDestroyPhase2.onload = ctx.drawImage(imgFlyerLargeDestroyPhase2, this.x, this.y - this.height, this.width, this.height);
                                } else if(phase === 3) {
                                    imgFlyerLargeDestroyPhase3.onload = ctx.drawImage(imgFlyerLargeDestroyPhase3, this.x, this.y - this.height, this.width, this.height);
                                } else if(phase === 4) {
                                    imgFlyerLargeDestroyPhase4.onload = ctx.drawImage(imgFlyerLargeDestroyPhase4, this.x, this.y - this.height, this.width, this.height);
                                } else if(phase === 5) {
                                    imgFlyerLargeDestroyPhase5.onload = ctx.drawImage(imgFlyerLargeDestroyPhase5, this.x, this.y - this.height, this.width, this.height);
                                }
                                break;
                            default: break;
                        }
                    };
                    this.attackInit = function(speed) {
                        this.x = Math.random() * (canvas.width-this.width);
                        this.y = 0;
                        this.speed = speed;
                        this.arrive = true;
                        this.draw();
                    };
                    this.attackEnd = function() {
                        this.arrive = false;
                        this.hit = false;
                        this.init(this.flyerSize);
                    };
                    this.attack = function() {
                        if(this.arrive) {
                            if((this.y >= canvas.height+this.height) || (this.hit && this.destroyDownCount <= 0)) {
                                this.attackEnd();
                            } else if(this.hit && this.destroyDownCount > 0) {
                                switch(this.flyerSize) {
                                    case FLYER_SMALL:
                                        if(this.destroyDownCount > 20) {
                                            this.drawDestroy(1);
                                        } else {
                                            this.drawDestroy(2);
                                        }
                                        break;
                                    case FLYER_MEDIUM:
                                        if(this.destroyDownCount > 30) {
                                            this.drawDestroy(1);
                                        } else if(this.destroyDownCount > 20) {
                                            this.drawDestroy(2);
                                        } else {
                                            this.drawDestroy(3);
                                        }
                                        break;
                                    case FLYER_LARGE:
                                        if(this.destroyDownCount > 50) {
                                            this.drawDestroy(1);
                                        } else if(this.destroyDownCount > 40) {
                                            this.drawDestroy(2);
                                        } else if(this.destroyDownCount > 30) {
                                            this.drawDestroy(3);
                                        } else if(this.destroyDownCount > 20) {
                                            this.drawDestroy(4);
                                        } else {
                                            this.drawDestroy(5);
                                        }
                                        break;
                                    default: break;
                                }
                                --this.destroyDownCount;
                            } else {
                                this.y += this.speed;
                                this.draw();
                            }
                        }
                    };
                    this.destroy = function() {
                        this.hit = true;
                        enemyMusic.currentTime = 0;
                        enemyMusic.play();
                        switch(this.flyerSize) {
                            case FLYER_SMALL: 
                                this.destroyDownCount = 30;
                                system.countScore(FLYER_SMALL);
                                break;
                            case FLYER_MEDIUM: 
                                this.destroyDownCount = 40;
                                system.countScore(FLYER_MEDIUM);
                                break;
                            case FLYER_LARGE: 
                                this.destroyDownCount = 60;
                                this.height = this.height + 15;
                                system.countScore(FLYER_LARGE);
                                break;
                            default: break;
                        }
                    };
                    this.hitBy = function() {
                        if(this.health > 0) {
                            if(ship.doubleBullet) {
                                this.health -= 2;
                            } else {
                                 --this.health;
                            }
                        }
                        if(this.health <= 0) {
                            this.destroy();
                        }
                    };
                }
                
                var flyerSmallArray = new Array();
                for(var i=0; i<numOfFlyersSmall; i++) {
                    flyerSmallArray[i] = new flyer();
                    flyerSmallArray[i].init(FLYER_SMALL);
                }
                var flyerMediumArray = new Array();
                for(var i=0; i<numOfFlyersMedium; i++) {
                    flyerMediumArray[i] = new flyer();
                    flyerMediumArray[i].init(FLYER_MEDIUM);
                }
                var flyerLargeArray = new Array();
                for(var i=0; i<numOfFlyersLarge; i++) {
                    flyerLargeArray[i] = new flyer();
                    flyerLargeArray[i].init(FLYER_LARGE);
                }
                
                var battle = {
                    cd: 60*2,
                    cding: false,
                    frequency: 60,
                    timerForSmall: 1,
                    timerMaxForSmall: 0,
                    timerForMedium: 1,
                    timerMaxForMedium: 0,
                    timerForLarge: 1,
                    timerMaxForLarge: 0,
                    reset: function() {
                        this.cd = 60*2;
                        this.cding = false;
                        this.timerForSmall = 1;
                        this.timerMaxForSmall = 0;
                        this.timerForMedium = 1;
                        this.timerMaxForMedium = 0;
                        this.timerForLarge = 1;
                        this.timerMaxForLarge = 0;
                    },
                    randomTimerMax: function(flyerSize, min, max) {
                        var minTimer = min * this.frequency;
                        var maxTimer = max * this.frequency;
                        switch(flyerSize) {
                            case FLYER_SMALL: 
                                this.timerMaxForSmall = (Math.random() * (maxTimer - minTimer)) + minTimer;
                                break;
                            case FLYER_MEDIUM:
                                this.timerMaxForMedium = (Math.random() * (maxTimer - minTimer)) + minTimer;
                                break;
                            case FLYER_LARGE:
                                this.timerMaxForLarge = (Math.random() * (maxTimer - minTimer)) + minTimer;
                                break;
                            default: break;
                        }
                        
                    },
                    // function plan();
                    // minForSmall - the minimum seconds interval to send a new small flyer; (unit: seconds)
                    // maxForSmall - the maximum seconds interval to send a new small flyer; (unit: seconds)
                    // minForMedium, maxForMedium, minForLarge, maxForLarge are the same just like the small one;
                    // smallSpeedUp - the probability that the next new small flyer will have a quick speed than normal, 
                    //                and the speed value is defined in SPEED_NORMAL and SPEED_QUICK; 
                    //                (unit: %, value from 0~100, -1 means no quick speed flyers)
                    // mediumSpeedUP, largeSpeedUp are the same like the small one;
                    // small - the number of small flyers that will be sent for each interval; (unit: flyers)
                    // medium, large are the same like the small one;
                    plan: function(minForSmall, maxForSmall, minForMedium, maxForMedium, minForLarge, maxForLarge, smallSpeedUp, mediumSpeedUp, largeSpeedUp, small, medium ,large) {
                        if(this.timerForSmall > this.timerMaxForSmall) {
                            this.timerForSmall = 1;
                            this.randomTimerMax(FLYER_SMALL, minForSmall, maxForSmall);
                        }
                        if(this.timerForMedium > this.timerMaxForMedium) {
                            this.timerForMedium = 1;
                            this.randomTimerMax(FLYER_MEDIUM, minForMedium, maxForMedium);
                        }
                        if(this.timerForLarge > this.timerMaxForLarge) {
                            this.timerForLarge = 1;
                            this.randomTimerMax(FLYER_LARGE, minForLarge, maxForLarge);
                        }
                        for(var i=0; i<numOfFlyersLarge; i++) {
                            var f = flyerLargeArray[i];
                            if(f.arrive) {
                                f.attack();
                            } else if(!f.arrive && this.timerForLarge === 1 && large > 0 && !this.cding) {
                                if(largeSpeedUp > 0 && Math.random()*100 <= largeSpeedUp) {
                                    f.attackInit(SPEED_QUICK-2);
                                } else {
                                    f.attackInit(SPEED_NORMAL);
                                }
                                --large;
                            }
                        }
                        for(var i=0; i<numOfFlyersMedium; i++) {
                            var f = flyerMediumArray[i];
                            if(f.arrive) {
                                f.attack();
                            } else if(!f.arrive && this.timerForMedium === 1 && medium > 0 && !this.cding) {
                                if(mediumSpeedUp > 0 && Math.random()*100 <= mediumSpeedUp) {
                                    f.attackInit(SPEED_QUICK-1);
                                } else {
                                    f.attackInit(SPEED_NORMAL);
                                }
                                --medium;
                            }
                        }
                        for(var i=0; i<numOfFlyersSmall; i++) {
                            var f = flyerSmallArray[i];
                            if(f.arrive) {
                                f.attack();
                            } else if(!f.arrive && this.timerForSmall === 1 && small > 0 && !this.cding) {
                                if(smallSpeedUp > 0 && Math.random()*100 <= smallSpeedUp) {
                                    f.attackInit(SPEED_QUICK);
                                } else {
                                    f.attackInit(SPEED_NORMAL);
                                }
                                --small;
                            }
                        }
                        
                        ++this.timerForSmall;
                        ++this.timerForMedium;
                        ++this.timerForLarge;
                    },
                    mission: function() {
                        if(this.cd <= 0) {
                            this.cding = false;
                            this.cd = 60*2;
                        }
                        
                        if(system.score < 7000) this.plan(1,2,0,0,0,0,-1,-1,-1,1,0,0);
                        else if(system.score < 53000) this.plan(0,3,3,4,0,0,-1,-1,-1,1,1,0);
                        else if(system.score < 130000) this.plan(1,2,3,6,15,20,20,-1,-1,1,1,1);
                        else if(system.score < 300000) this.plan(1,2,3,4,12,17,30,-1,-1,1,1,1);
                        else if(system.score < 410000) this.plan(0,1,1,2,12,17,30,20,-1,1,1,1);
                        else if(system.score < 530000) this.plan(0,1,0,1,8,11,30,25,-1,1,1,1);
                        else if(system.score < 710000) this.plan(0,1,0,1,5,6,30,25,-1,1,1,1);
                        else if(system.score < 1010000) this.plan(0,1,0,2,2,3,40,30,25,1,1,1);
                        else this.plan(0,1,0,1,1,2,70,50,40,2,1,1);
                        
                        if(this.cding) {
                            --this.cd;
                        }
                    }
                };
                
                var supply = {
                    ready: false,
                    dropBomb: false,
                    dropBullet: false,
                    cd: 60*10,
                    bombProbability: 10,
                    bulletProbability: 8,
                    bombX: 0,
                    bombY: 0,
                    bulletX: 0,
                    bulletY: 0,
                    itemWidth: 40,
                    itemHeight: 70,
                    speed: 1.5,
                    reset: function() {
                        this.ready = false;
                        this.dropBomb = false;
                        this.dropBullet = false;
                        this.cd = 60*10;
                    },
                    init: function(item) {
                        if(item === "bomb") {
                            this.dropBomb = true;
                            this.bombX = Math.random()*(canvas.width - this.itemWidth);
                            this.bombY = 0 - this.itemHeight;
                        }
                        if(item === "bullet") {
                            this.dropBullet = true;
                            this.bulletX = Math.random()*(canvas.width - this.itemWidth);
                            this.bulletY = 0 - this.itemHeight;
                        }
                    },
                    draw: function(item) {
                        if(item === "bomb") {
                            imgBombSupply.onload = ctx.drawImage(imgBombSupply, this.bombX, this.bombY, this.itemWidth, this.itemHeight);
                        }
                        if(item === "bullet") {
                            imgBulletDoubleSupply.onload = ctx.drawImage(imgBulletDoubleSupply, this.bulletX, this.bulletY, this.itemWidth, this.itemHeight);
                        }
                    },
                    permission: function() {
                        if(Math.random()*100 < this.bombProbability) {
                            this.init("bomb");
                            this.draw("bomb");
                        }
                        if(Math.random()*100 < this.bulletProbability) {
                            this.init("bullet");
                            this.draw("bullet");
                        }
                    },
                    deliver: function() {
                        if(this.cd <= 0) {
                            this.ready = true;
                            this.cd = 60*10;
                        }
                        if(this.ready && !this.dropBomb && !this.dropBullet) {
                            this.permission();
                            this.ready = false;
                        } else {
                            --this.cd;
                        }
                        if(this.dropBomb) {
                            if(this.bombY > canvas.height) {
                                this.dropBomb = false;
                            } else {
                                this.bombY += this.speed;
                                this.draw("bomb");
                            }
                        }
                        if(this.dropBullet) {
                            if(this.bulletY > canvas.height) {
                                this.dropBullet = false;
                            } else {
                                this.bulletY += this.speed;
                                this.draw("bullet");
                            }
                        }
                    }
                };
                
                var system = {
                    score: 0,
                    scoreSmall: 1000,
                    scoreMedium: 6000,
                    scoreLarge: 30000,
                    flagGameStart: false,
                    flagGameOver: false,
                    reset: function() {
                        this.score = 0;
                        this.flagGameOver = false;
                        this.flagGameStart = false;
                    },
                    gameover: function() {
                        ship.crashed = true;
                        ship.setFinalPos(ship.x, ship.y);
                    },
                    blowup: function() {
                        battle.cding = true;
                        for(var i=0; i<numOfFlyersSmall; i++) {
                            var f = flyerSmallArray[i];
                            if(f.arrive) {
                                f.destroy();
                            }
                        }
                        for(var i=0; i<numOfFlyersMedium; i++) {
                            var f = flyerMediumArray[i];
                            if(f.arrive) {
                                f.destroy();
                            }
                        }
                        for(var i=0; i<numOfFlyersLarge; i++) {
                            var f = flyerLargeArray[i];
                            if(f.arrive) {
                                f.destroy();
                            }
                        }
                    },
                    referee: function() {
                        // check if flyers are hit by bullets
                        for(var i=0; i<numOfBullets; i++) {
                            var b = bulletArray[i];
                            var bwidth = b.bWidth();
                            if(ship.doubleBullet) bwidth = b.bWidthDouble();
                            
                            if(b.fire) {
                                for(var j=0; j<numOfFlyersSmall; j++) {
                                    var f = flyerSmallArray[j];
                                    if(f.arrive && !f.hit
                                            && (b.startX + bwidth > f.x) && (b.startX < f.x + f.width) 
                                            && (b.startY < f.y) && (b.startY + b.height > f.y - f.height)) {
                                        // hit!
                                        b.fire = false;
                                        f.hitBy();
                                        break;
                                    }
                                }
                            }
                            if(b.fire) {
                                for(var j=0; j<numOfFlyersMedium; j++) {
                                    var f = flyerMediumArray[j];
                                    if(f.arrive && !f.hit
                                            && (b.startX + bwidth > f.x) && (b.startX < f.x + f.width) 
                                            && (b.startY < f.y) && (b.startY + b.height > f.y - f.height)) {
                                        // hit!
                                        b.fire = false;
                                        f.hitBy();
                                        break;
                                    }
                                }
                            }
                            if(b.fire) {
                                for(var j=0; j<numOfFlyersLarge; j++) {
                                    var f = flyerLargeArray[j];
                                    if(f.arrive && !f.hit
                                            && (b.startX + bwidth > f.x) && (b.startX < f.x + f.width) 
                                            && (b.startY < f.y) && (b.startY + b.height > f.y - f.height)) {
                                        // hit!
                                        b.fire = false;
                                        f.hitBy();
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // check if the space ship crashed with flyers
                        // if crashed, game over
                        for(var i=0; i<numOfFlyersSmall; i++) {
                            var f = flyerSmallArray[i];
                            if(f.arrive && !f.hit
                                    && (f.x < ship.x + ship.width - 15)
                                    && (f.x + f.width > ship.x + 15)
                                    && (f.y - f.height < ship.y + ship.height - 15)
                                    && (f.y > ship.y + 15)) {
                                f.destroy();
                                this.gameover();
                                break;
                            }
                        }
                        for(var i=0; i<numOfFlyersMedium; i++) {
                            var f = flyerMediumArray[i];
                            if(f.arrive && !f.hit
                                    && (f.x < ship.x + ship.width - 15)
                                    && (f.x + f.width > ship.x + 15)
                                    && (f.y - f.height < ship.y + ship.height - 25)
                                    && (f.y > ship.y + 25)) {
                                f.destroy();
                                this.gameover();
                                break;
                            }
                        }
                        for(var i=0; i<numOfFlyersLarge; i++) {
                            var f = flyerLargeArray[i];
                            if(f.arrive && !f.hit
                                    && (f.x < ship.x + ship.width - 20)
                                    && (f.x + f.width > ship.x + 20)
                                    && (f.y - f.height + 30 < ship.y + ship.height - 15)
                                    && (f.y > ship.y + 35)) {
                                f.destroy();
                                this.gameover();
                                break;
                            }
                        }
                        
                        // check if the space ship catch the supplies
                        if(supply.dropBomb) {
                            if(supply.bombX + supply.itemWidth >= ship.x + 10
                                    && supply.bombX <= ship.x + ship.width - 10
                                    && supply.bombY + supply.itemHeight >= ship.y + 5
                                    && supply.bombY + 40 <= ship.y + ship.height - 5) {
                                supply.dropBomb = false;
                                ship.loadBomb();
                            }
                        }
                        if(supply.dropBullet) {
                            if(supply.bulletX + supply.itemWidth >= ship.x + 10
                                    && supply.bulletX <= ship.x + ship.width - 10
                                    && supply.bulletY + supply.itemHeight >= ship.y + 5
                                    && supply.bulletY + 40 <= ship.y + ship.height - 5) {
                                supply.dropBullet = false;
                                ship.doubleBullet = true;
                                ship.doubleBulletPeriod = 60*15;
                            }
                        }
                        
                    },
                    countScore: function(flyerSize) {
                        switch(flyerSize) {
                            case FLYER_SMALL: this.score += this.scoreSmall; break;
                            case FLYER_MEDIUM: this.score += this.scoreMedium; break;
                            case FLYER_LARGE: this.score += this.scoreLarge; break;
                            default: break;
                        }
                    },
                    draw: function() {
                        ctx.save();
                        ctx.font = "28px 'Comic Sans MS', cursive, sans-serif";
                        ctx.fillStyle = "#616161";
                        ctx.fillText(this.score, 40,40);
                        ctx.restore();
                    }
                };
                
                
                function init() {
                    // custom init here
                    canvas.onmousemove = function(event) {
                        mouseX = event.clientX - canvas.offsetLeft;
                        mouseY = event.clientY;
                    };
                    
                    canvas.onmousedown = function(e) {
                        document.oncontextmenu = function(e) {
                            e.preventDefault();
                        };
                        if(e.button === 2) {
                            ship.useBomb();
                        }
                    };
                    
                    var key;
                    document.addEventListener("keypress", function(e) {
                        if(window.event) {
                            key = e.keyCode;
                        } else if(e.which) {
                            key = e.which;
                        }
                        if(key === 32) {
                            if(flagGamePause) {
                                flagGamePause = false;
                                bgmusic.play();
                                raf = window.requestAnimationFrame(draw);
                            } else {
                                flagGamePause = true;
                                bgmusic.pause();
                                window.cancelAnimationFrame(raf);
                            }
                        }
                    });
                    
                    background.init();
                }
                
                function resetAll() {
                    for(var i=0; i<numOfBullets; i++) {
                        bulletArray[i].reset();
                    }
                    ship.reset();
                    for(var i=0; i<numOfFlyersSmall; i++) {
                        flyerSmallArray[i].reset();
                    }
                    for(var i=0; i<numOfFlyersMedium; i++) {
                        flyerMediumArray[i].reset();
                    }
                    for(var i=0; i<numOfFlyersLarge; i++) {
                        flyerLargeArray[i].reset();
                    }
                    battle.reset();
                    supply.reset();
                    system.reset();
                }
                
                function generateScore() {
                    var topScore = 0;
                    var curScore = system.score;
                    if(localStorage.topScore) {
                        topScore = localStorage.topScore;
                    } else {
                        localStorage.topScore = 0;
                    }
                    
                    scoreContainer.innerHTML = 
                            "<p class='score-title'>Score</p>"
                        +   "<p class='score-num'>" + curScore + "</p>"
                        +   "<div class='newtop-container'>"
                        +   "<p id='newtop'>NEW TOP RECORD!!!</p>"
                        +   "</div>"
                        +   "<p class='topscore'>Top Score: " + topScore + "</p>";
                
                    var newtop = document.getElementById("newtop");
                    if(curScore > topScore) {
                        newtop.style.display = "block";
                        localStorage.topScore = curScore;
                    } else {
                        newtop.style.display = "none";
                    }
                }
            

                function draw() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // draw background
                    background.draw();
                    
                    if(!system.flagGameOver && system.flagGameStart) {
                        // draw pattern here
                        if(ship.crashed) {
                            ship.destroy();
                        } else {
                            ship.x = mouseX - ship.width/2;
                            ship.y = mouseY - ship.height/2;
                            ship.draw();
                            ship.fire();
                        }
                        battle.mission();
                        supply.deliver();
                        if(!ship.crashed) {
                            system.referee();
                        }
                        system.draw();
                        ship.drawBomb();
                        
                        
                    } else if(system.flagGameOver && system.flagGameStart) {
                        // game over
                        // generate score
                        bgmusic.pause();
                        gameoverMusic.play();
                        generateScore();
                        
                        // reset game
                        resetAll();
                        
                        // show score wall and play button
                        titleContainer.style.display = "none";
                        scoreContainer.style.display = "block";
                        dialogContainer.style.display = "block";
                    }
                    
                    raf = window.requestAnimationFrame(draw);
                }
        
                // main implementation
                init();
                raf = window.requestAnimationFrame(draw);
                
                var startup = document.getElementById("startup");
                startup.addEventListener("click", function(e) {
                    dialogContainer.style.display = "none";
                    bgmusic.currentTime = 0;
                    bgmusic.play();
                    system.flagGameStart = true;
                });
                generateScore();
            } // end of game()
            
            

            window.onload = function() {
                var gameContainer = document.getElementById("game-container");
                gameContainer.style.height = window.innerHeight - 5 + "px";
                if(gameContainer.offsetHeight <= 600) {
                    gameContainer.style.height = "600px";
                } else if(gameContainer.offsetHeight >= 800) {
                    gameContainer.style.height = "800px";
                }
                gameContainer.style.width = (gameContainer.offsetHeight / 1.6) + "px";
                game();
                
            };
            
        </script>
        
    </head>
    <body>
        <div id="game-container">
            <canvas id="canvas" width="400" height="400"></canvas>
            <div id="dialog-container">
                <div id="title">
                    <img src="images/title-main.png" alt="game-title" width="280" height="180" />
                    <div class="help">
                        <img src="images/move.png" alt="move" width="40" height="30" />
                        <img src="images/equal.png" alt="move" width="30" height="30" />
                        <img src="images/mouse.png" alt="move" width="30" height="30" />
                    </div>
                    <div class="help">
                        <img src="images/bomb.png" alt="move" width="40" height="30" />
                        <img src="images/equal.png" alt="move" width="30" height="30" />
                        <img src="images/mouse_right_click.png" alt="move" width="30" height="30" />
                    </div>
                    <div class="help">
                        <img src="images/pause.png" alt="move" width="40" height="30" />
                        <img src="images/equal.png" alt="move" width="30" height="30" />
                        <img src="images/spacebar.png" alt="move" width="40" height="30" />
                    </div>
                </div>
                <div id="score"></div>
                <div id="startup">
                    <img src="images/button-start.png" alt="button-start" width="100" height="100" />
                </div>
            </div>
            <audio id="bgmusic" src="sound/game_music.mp3" loop="loop"></audio>
            <audio id="gameover-music" src="sound/game_over.mp3"></audio>
            <!--<audio id="bullet-music" src="sound/bullet.mp3"></audio>-->
            <audio id="enemy-music" src="sound/enemy_down.mp3"></audio>
        </div>
    </body>
</html>
